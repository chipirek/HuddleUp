<!-- row -->
<div class="row">

  <!-- col -->
  <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
    <h6 class="page-title txt-color-blueDark">
      <!-- PAGE HEADER -->
      <i class="fa-fw fa fa-road"></i>
      Summary at a Glance
    </h6>
  </div>
  <!-- end col -->

  <div class="col-xs-12 col-sm-3 col-md-3 col-lg-5 pull-right">

    <% if @project.current_user_is_project_admin?(current_user.id) %>
        <%= link_to 'Admin: Edit this project definition', edit_project_path, :class => 'btn btn-success btn-lg pull-right header-btn hidden-mobile' %>
    <% end %>

  </div>

</div>
<!-- end row -->

<!-- row -->
<div class="row">
  <div class="col-sm-12">
    <h3><%= @project.name %></h3>
    <p><%= @project.description.html_safe unless @project.description.nil? %></p>
    <p>
        <% if @project.status_code==1 %>
            <div class='alert alert-block alert-success'>We are on track</div>
        <% elsif @project.status_code==2 %>
            <div class='alert alert-block alert-warning'>Project is troubled</div>
        <% else %>
            <div class='alert alert-block alert-danger'>Project is late or failing</div>
        <% end %>
    </p>

  </div>
</div>



<section id="widget-grid">

<div class="row">

<article class="col-sm-12 col-md-12 col-lg-6">

  <!-- -------------------------------------------------------------------------------------------- -->
  <!-- alerts widget -->
  <!-- -------------------------------------------------------------------------------------------- -->
  <div class="jarviswidget jarviswidget-color-blue" id="wid-id-1" data-widget-editbutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false">
    <header>
      <span class="widget-icon"> <i class="fa fa-bell"></i> </span>
      <h2>Alerts</h2>
    </header>

    <!-- widget div-->
    <div>
      <div class="widget-body">
        <!-- content goes here -->
        <span class='margin-left:15px;'>Alerts are not running...</span>
        <!-- end content -->
      </div>
    </div>
    <!-- end widget div -->
  </div>
  <!-- end widget -->

  <!-- -------------------------------------------------------------------------------------------- -->
  <!-- milestones widget -->
  <!-- -------------------------------------------------------------------------------------------- -->
  <div class="jarviswidget jarviswidget-color-blue" id="wid-id-2" data-widget-editbutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false">
    <header>
      <span class="widget-icon"> <i class="fa fa-calendar"></i> </span>
      <h2> My Events </h2>
    </header>

    <!-- widget div-->
    <div>
      <div class="widget-body">
        <div class='well'>
            <div id="calendar" style='padding-top: 30px;'></div>
        </div>
      </div>
    </div>
    <!-- end widget div -->
  </div>
  <!-- end widget -->

</article>

<article class="col-sm-12 col-md-12 col-lg-6">

  <!-- -------------------------------------------------------------------------------------------- -->
  <!-- issues widget -->
  <!-- -------------------------------------------------------------------------------------------- -->
  <div class="jarviswidget jarviswidget-color-blue" id="wid-id-3" data-widget-editbutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false">
    <header>
      <span class="widget-icon"> <i class="fa fa-bug txt-color-white"></i> </span>
      <h2> Unresolved Issues </h2>
    </header>
    <div>
      <div class="widget-body no-padding smart-form">
        <% if @project.issues.where('is_resolved != true or is_resolved is null').count == 0 %>
            <span style='margin-top:15px; margin-left:15px;'>None</span>
        <% else %>

          <!-- content goes here -->
            <h5 class="todo-group-title"> Unresolved Issues (<small class="num-of-tasks"><%= @project.issues.where('is_resolved != true or is_resolved is null').count %></small>)
            </h5>
            <ul id="sortable2" class="todo">
              <% @project.issues.where('is_resolved != true or is_resolved is null').each do |issue| %>
                  <li data-pk='<%= issue.id %>'>
                    <span class="handle" style="display:none"> <label class="checkbox state-disabled">
                      <input type="checkbox" name="checkbox-inline" checked="checked" disabled="disabled">
                      <i></i> </label> </span>

                    <p>
                      <strong> #<%= issue.id %></strong> - <%= issue.subject %>
                      <%= link_to '[More...]', edit_project_issue_path(@project, issue), {:class=>'font-xs'} %>
                      <span class="text-muted"><%= issue.description %> </span>
                      <span class="date">Created <%= time_ago_in_words(issue.created_at) %> ago.</span>
                    </p>
                  </li>
              <% end %>
            </ul>
            <!-- end content -->
        <% end %>
      </div>
    </div>
    <!-- end widget div -->
  </div>
  <!-- end widget -->

  <!-- -------------------------------------------------------------------------------------------- -->
  <!-- todos widget -->
  <!-- -------------------------------------------------------------------------------------------- -->
  <div class="jarviswidget jarviswidget-color-blue" id="wid-id-4" data-widget-editbutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false">
    <header>
      <span class="widget-icon"> <i class="fa fa-check-square-o txt-color-white"></i> </span>
      <h2> Incomplete Todos </h2>
    </header>
    <div>
      <div class="widget-body no-padding smart-form">
        <% if @project.todos.where('is_complete != true or is_complete is null').count == 0 %>
            <span style='margin-top:15px; margin-left:15px;'>None</span>
        <% else %>

          <!-- content goes here -->
            <h5 class="todo-group-title"> Incomplete Todos (<small class="num-of-tasks"><%= @project.todos.where('is_complete != true or is_complete is null').count %></small>)
            </h5>
            <ul id="sortable2" class="todo">
              <% @project.todos.where('is_complete != true or is_complete is null').each do |todo| %>
                  <li data-pk='<%= todo.id %>'>
                    <span class="handle">
                      <label class="checkbox">
                        <input type="checkbox" name="checkbox-inline">
                        <i></i> </label>
                    </span>

                    <p>
                      <strong> #<%= todo.id %></strong> - <%= todo.subject %>
                      <%= link_to '[More...]', edit_project_todo_path(@project, todo), {:class=>'font-xs'} %>
                      <span class="text-muted"><%= todo.description %> </span>
                      <span class="date">Created <%= time_ago_in_words(todo.created_at) %> ago.</span>
                    </p>
                  </li>
              <% end %>
            </ul>
            <!-- end content -->
        <% end %>
      </div>
    </div>
    <!-- end widget div -->
  </div>
  <!-- end widget -->

</article>

</div>

<!-- end row -->

</section>
<!-- end widget grid -->

</div>

<!-- -------------------------------------------------------------------------------------------- -->


<%= render :partial => '/projects/scripts' %>
<script src="/SmartAdmin/js/plugin/fullcalendar/jquery.fullcalendar.min.js"></script>

<script>
    $(document).ready(function () {

        // DO NOT REMOVE : GLOBAL FUNCTIONS!
        pageSetUp();

        // initialize sortable
        $(function () {
            $("#sortable1, #sortable2").sortable({
                handle: '.handle',
                connectWith: ".todo",
                update: countTasks
            }).disableSelection();
        });

        // check and uncheck
        $('.todo .checkbox > input[type="checkbox"]').click(function () {
            var $this = $(this).parent().parent().parent();

            if ($(this).prop('checked')) {
                $this.addClass("complete");

                // remove this if you want to undo a check list once checked
                //$(this).attr("disabled", true);
                $(this).parent().hide();

                // once clicked - add class, copy to memory then remove and add to sortable3
                $this.slideUp(500, function () {
                    //$this.clone().prependTo("#sortable3").effect("highlight", {}, 800);
                    $this.remove();
                    countTasks();
                });

                // ajax update back to database
                var pk = $this.attr('data-pk');
                var url = '/projects/<%= @project.id %>/todos/mark_complete/' + pk;
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: { _method:'PUT' },
                    success: function(msg) {
                        console.log( "Data Saved: " + msg );
                    }
                });
            } else {
                // insert undo code here...
            }

        })
        // count tasks
        function countTasks() {

            $('.todo-group-title').each(function () {
                var $this = $(this);
                $this.find(".num-of-tasks").text($this.next().find("li").size());
            });

            var c = 0;
            $('.todo-group-title').each(function () {
                var $this = $(this);
                if ($this.next().attr('id') != 'sortable3')
                    c += $this.next().find("li").size();
            });

            if (c == 0)
                $('#badgeTodosCount').text("");
            else
                $('#badgeTodosCount').text(c);

        }

        if ($("#calendar").length) {
            var date = new Date();
            var d = date.getDate();
            var m = date.getMonth();
            var y = date.getFullYear();

            var calendar = $('#calendar').fullCalendar({

                editable: true,
                //draggable: true,
                selectable: false,
                selectHelper: true,
                unselectAuto: false,
                disableResizing: false,

                header: {
                    left: 'title', //,today
                    center: 'prev, next, today',
                    right: 'month, agendaWeek, agendaDay' //month, agendaDay,
                },

                events: [
                    <% @project.milestones.each do |m| %>
                    {"all_day":<%= m.all_day? %>,
                        "className":"<%= m.class_name %>",
                        "end":"<%= m.end %>",
                        "id":<%= m.id %>,
                        "project_id":<%= m.project_id %>,
                        "start":"<%= m.start %>",
                        "title":"<%= m.title %>" },
                    <% end %>
                ],

                eventRender : function(event, element, icon) {
                    if (!event.description == "") {
                        element.find('.fc-event-title').append("<br/><span class='ultra-light'>" + event.description + "</span>");
                    }
                    if (!event.icon == "") {
                        element.find('.fc-event-title').append("<i class='air air-top-right fa " + event.icon + " '></i>");
                    }
                },

                eventClick: function(event) {
                    // opens events in a popup window
                    // alert(event.id);
                    window.location.href = '/projects/<%= @project.id %>/milestones/' + event.id + '/edit';
                    return false;
                }

            });

        };

    });

</script>

<!-- Your GOOGLE ANALYTICS CODE Below -->
<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-XXXXXXXX-X']);
    _gaq.push(['_trackPageview']);

    (function () {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
    })();

</script>
